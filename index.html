<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WordBoards – Training Words Editor</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
      line-height: 1.5;
    }
    h1 { margin-bottom: 0.5rem; }
    textarea {
      width: 100%;
      height: 250px;
      font-family: monospace;
      font-size: 14px;
    }
    label {
      font-weight: 600;
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.25rem;
    }
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 0.4rem;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 14px;
      cursor: pointer;
    }
    .row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .row > div {
      flex: 1 1 200px;
    }
    #status {
      margin-top: 1rem;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 14px;
      display: none;
    }
    #status.error {
      background: #ffe5e5;
      color: #a30000;
    }
    #status.success {
      background: #e6ffed;
      color: #006400;
    }
    pre {
      background: #f4f4f4;
      padding: 0.75rem;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>WordBoards – Training Words Editor</h1>
  <p>
    Enter one word per line. Click <strong>Save to GitHub</strong> to overwrite
    <code>words.json</code> in the <code>desileal/WordBoards</code> repo.
  </p>
  <div class="row">
    <div>
      <label for="warmupwords">Three warmup words (including name)</label>
      <textarea id="warmupwords" placeholder="00000
12345
DESIREE"></textarea>
    </div>
    <div>
      <label for="fourletterwords">Five four-letter words</label>
      <textarea id="fourletterwords" placeholder="BLUE
WIRE
GRAB
      ..."></textarea>
    </div>
    <div>
      <label for="fiveletterwords">Five five-letter words</label>
      <textarea id="fiveletterwords" placeholder="WHALE
SHARK
MOUSE
      ..."></textarea>
    </div>
    <div>
      <label for="challengewords">Five challenge words</label>
      <textarea id="challengewords" placeholder="COLLOQUIAL
UBIQUITOUS
PRESCIENT
      ..."></textarea>
    </div>
  </div>
  <label for="words">Words (one per line)</label>
  <textarea id="words" placeholder="Example:
BUG
FLY
SAP
BIRD
..."></textarea>

  <div class="row">
    <div>
      <label for="owner">GitHub Owner</label>
      <input id="owner" type="text" value="desileal" />
    </div>
    <div>
      <label for="repo">Repository</label>
      <input id="repo" type="text" value="WordBoards" />
    </div>
    <div>
      <label for="branch">Branch</label>
      <input id="branch" type="text" value="main" />
    </div>
  </div>

  <label for="token">GitHub Personal Access Token (not stored)</label>
  <input id="token" type="password" placeholder="Paste your fine-grained PAT here" />

  <div class="row">
    <button id="loadBtn">Load current words.json from GitHub</button>
    <button id="saveBtn">Save to GitHub</button>
  </div>

  <div id="status"></div>

  <h2>Preview of words.json</h2>
  <pre id="preview">{}</pre>

  <script>
    function showStatus(message, isError = false) {
      const status = document.getElementById("status");
      status.textContent = message;
      status.className = isError ? "error" : "success";
      status.style.display = "block";
    }

    function clearStatus() {
      const status = document.getElementById("status");
      status.style.display = "none";
      status.textContent = "";
      status.className = "";
    }

    function wordsToJson() {
      const text = document.getElementById("words").value;
      const lines = text
        .split("\n")
        .map((l) => l.trim())
        .filter((l) => l.length > 0);

      const obj = { words: lines };
      const json = JSON.stringify(obj, null, 2);
      document.getElementById("preview").textContent = json;
      return json;
    }

    function base64EncodeUnicode(str) {
      // GitHub API expects base64-encoded content
      return btoa(unescape(encodeURIComponent(str)));
    }

    async function loadCurrentWords() {
      clearStatus();
      const owner = document.getElementById("owner").value.trim();
      const repo = document.getElementById("repo").value.trim();
      const branch = document.getElementById("branch").value.trim();
      const token = document.getElementById("token").value.trim();

      if (!owner || !repo || !branch || !token) {
        showStatus("Owner, repo, branch, and token are required.", true);
        return;
      }

      const url = `https://api.github.com/repos/${owner}/${repo}/contents/words.json?ref=${encodeURIComponent(branch)}`;

      try {
        const res = await fetch(url, {
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: "application/vnd.github+json",
          },
        });

        if (res.status === 404) {
          showStatus("words.json not found on this branch. It will be created when you save.");
          return;
        }

        if (!res.ok) {
          const txt = await res.text();
          showStatus(`Failed to load words.json: ${res.status} ${txt}`, true);
          return;
        }

        const data = await res.json();
        if (!data.content) {
          showStatus("words.json has no content field.", true);
          return;
        }

        const decoded = decodeURIComponent(escape(atob(data.content)));
        document.getElementById("preview").textContent = decoded;

        // Try to parse to put back in textarea as lines
        try {
          const parsed = JSON.parse(decoded);
          if (parsed.words && Array.isArray(parsed.words)) {
            document.getElementById("words").value = parsed.words.join("\n");
          }
        } catch (e) {
          // If parse fails, just leave preview as raw JSON
        }

        showStatus("Loaded words.json from GitHub.");
      } catch (e) {
        showStatus("Error loading words.json: " + e.message, true);
      }
    }

    async function saveWords() {
      clearStatus();
      const owner = document.getElementById("owner").value.trim();
      const repo = document.getElementById("repo").value.trim();
      const branch = document.getElementById("branch").value.trim();
      const token = document.getElementById("token").value.trim();

      if (!owner || !repo || !branch || !token) {
        showStatus("Owner, repo, branch, and token are required.", true);
        return;
      }

      const json = wordsToJson();
      const contentB64 = base64EncodeUnicode(json);
      const path = "words.json";
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;

      let currentSha = null;

      // First, try to get existing file to obtain its SHA
      try {
        const getRes = await fetch(`${apiUrl}?ref=${encodeURIComponent(branch)}`, {
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: "application/vnd.github+json",
          },
        });

        if (getRes.ok) {
          const existing = await getRes.json();
          currentSha = existing.sha;
        } else if (getRes.status !== 404) {
          const txt = await getRes.text();
          showStatus(`Error checking existing words.json: ${getRes.status} ${txt}`, true);
          return;
        }
      } catch (e) {
        showStatus("Error checking existing words.json: " + e.message, true);
        return;
      }

      const payload = {
        message: "Update words.json via WordBoards editor",
        content: contentB64,
        branch: branch,
      };

      if (currentSha) {
        payload.sha = currentSha;
      }

      try {
        const putRes = await fetch(apiUrl, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: "application/vnd.github+json",
          },
          body: JSON.stringify(payload),
        });

        if (!putRes.ok) {
          const txt = await putRes.text();
          showStatus(`Failed to save words.json: ${putRes.status} ${txt}`, true);
          return;
        }

        showStatus("Successfully saved words.json to GitHub.");
      } catch (e) {
        showStatus("Error saving words.json: " + e.message, true);
      }
    }

    document.getElementById("loadBtn").addEventListener("click", loadCurrentWords);
    document.getElementById("saveBtn").addEventListener("click", saveWords);

    // Keep preview in sync as user types
    document.getElementById("words").addEventListener("input", () => {
      try {
        wordsToJson();
      } catch {
        // ignore
      }
    });
  </script>
</body>
</html>
